*** Settings ***
Library           Selenium2Library
Resource          ../Common_Resources/common_resources.txt
Variables         ../Common_Resources/objRepPFM.py
Library           Collections
Library           String

*** Keywords ***
Create_Tags
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Wait Until Page Contains Element    ${objOverviewIncomeInvestmentCat}    5S
    AppiumLibrary.Click Element    ${objOverviewIncomeInvestmentCat}
    AppiumLibrary.Capture Page Screenshot
    Comment    AppiumLibrary.Page Should Contain    Shares
    AppiumLibrary.Click Element    ${objOverviewIncomeInvestShareSubCat}
    AppiumLibrary.Capture Page Screenshot
    ${beneName}=    AppiumLibrary.get element attribute    xpath=//div[@class='transactions list-view']/div[1]/a[@class='list-item-content']/div//div[@class='beneficiary']    textContent
    AppiumLibrary.Click Element    ${objOverviewInvestShareFirstTransaction}
    Sleep    3S
    AppiumLibrary.Capture Page Screenshot
    ${ToName}=    AppiumLibrary.get element attribute    xpath=.//*[@id='wrapper']//div[@class='content']//dd/p[@class='to']    textContent
    Comment    Select Window    new
    Get Lines Containing String    ${ToName}    ${beneName}
    AppiumLibrary.Page Should Contain Element    ${objTransactionWindowAddTag}
    AppiumLibrary.Capture Page Screenshot
    Comment    ${Elements}=    AppiumLibrary.Get Elements    xpath = .//*[@id='wrapper']//div[@class='autocomplete_field']/a[@class='tag removable' and contains(.,'NewTag')]
    Comment    ${var}=    Get Length    ${Elements}
    ${var}=    Set Variable    0
    AppiumLibrary.Input Text    ${objTransactionWindowAddTag}    NewTag
    AppiumLibrary.Click Element    ${objTransactionWindowAddButton}
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Wait Until Page Contains Element    ${objTransactionWindowAddedTag}    2S
    Run Keyword IF    ${var}==1    AppiumLibrary.Page Should Contain Element    ${objTransactionWindowTagExist}
    ...    ELSE    Run Keyword    Check_TagValue    1
    AppiumLibrary.Capture Page Screenshot

Check_TagValue
    [Arguments]    ${TagCheck}
    ${Elements}=    AppiumLibrary.Get Elements    xpath = .//*[@id='wrapper']//div[@class='autocomplete_field']/a
    ${count}=    Get Length    ${Elements}
    Log    ${count}
    ${Tagname}=    Create List
    : FOR    ${i}    IN RANGE    1    ${count}+1
    \    ${addedTag}=    AppiumLibrary.get element attribute    ${objTransactionWindowAddedTag}[${i}]    textContent
    \    Append To List    ${Tagname}    ${addedTag}
    log    ${Tagname}
    Run keyword If    ${TagCheck}==1    Should Contain    ${Tagname}    NewTag
    ...    ELSE    Should Not Contain    ${Tagname}    NewTag
    AppiumLibrary.Capture Page Screenshot

View_All_Tags_Module
    ${months}=    Month_Dictionary
    log    ${months}
    AppiumLibrary.Click Element    ${objOverviewHeaderInActive}
    AppiumLibrary.Wait Until Page Contains Element    ${objOverviewIncomeInvestmentCat}    5S
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Click Element    ${objOverviewIncomeInvestmentCat}
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Click Element    ${objOverviewIncomeInvestShareSubCat}
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Click Element    xpath = .//*[@id='wrapper']//div[@class='tag'][contains(.,'NewTag')]
    Sleep    3S
    AppiumLibrary.Click Element    ${objTransactionWindowAddedTag}[1]
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Click Element    ${objTransactionWindowViewAllTagsLink}
    AppiumLibrary.Wait Until Page Contains Element    ${objTagsHeaderActive}    5S
    AppiumLibrary.Capture Page Screenshot
    sleep    2S
    AppiumLibrary.Click Element    ${objOverviewDateIconOpen}
    sleep    2S
    ${TagStartHeader}=    AppiumLibrary.get element attribute    xpath=.//*[@id='wrapper']//div[@class='date-header']/span[1]    textContent
    ${TagEndHeader}=    AppiumLibrary.get element attribute    xpath=.//*[@id='wrapper']//div[@class='date-header']/span[2]    textContent
    ${From}=    AppiumLibrary.get element attribute    ${objFromDate}    value
    ${To}=    AppiumLibrary.get element attribute    ${objToDate}    value
    @{FromDate}=    Split String    ${From}    /
    log    ${FromDate[0]}
    ${FromMonth}=    Convert To Integer    ${FromDate[0]}
    ${FromDay}=    Convert To Integer    ${FromDate[1]}
    Should Contain    ${months['${FromMonth}']} ${FromDay}    ${TagStartHeader}
    @{ToDate}=    Split String    ${To}    /
    ${ToMonth}=    Convert To Integer    ${ToDate[0]}
    ${ToDay}=    Convert To Integer    ${ToDate[1]}
    Should Contain    ${months['${ToMonth}']} ${ToDay}    ${TagEndHeader}

View_Created_Tag_Under_ModuleTags
    [Arguments]    ${TagCheck}
    ${MatchElements}=    AppiumLibrary.Get Elements    xpath=.//*[@id='wrapper']//div[@class='list-item-toggle']//div[@class='title']
    ${TagName}=    Get Length    ${MatchElements}
    log    ${TagName}
    Comment    ${list}=    Create List
    Comment    : FOR    ${i}    IN RANGE    1    ${TagName}+1
    Comment    \    ${test}=    Execute JavaScript    return document.querySelectorAll(".title").item(${i}).innerHTML
    Comment    \    Append To List    ${list}    ${test}
    Comment    log    ${list}
    Comment    Run keyword If    ${TagCheck}==1    Should Contain    ${list}    NewTag
    ...    ELSE    Should Not Contain    ${list}    NewTag

Month_Dictionary
    ${month}=    Create Dictionary
    Set To Dictionary    ${month}    1    January
    Set To Dictionary    ${month}    2    February
    Set To Dictionary    ${month}    3    March
    Set To Dictionary    ${month}    4    April
    Set To Dictionary    ${month}    5    May
    Set To Dictionary    ${month}    6    June
    Set To Dictionary    ${month}    7    July
    Set To Dictionary    ${month}    8    August
    Set To Dictionary    ${month}    9    September
    Set To Dictionary    ${month}    10    October
    Set To Dictionary    ${month}    11    November
    Set To Dictionary    ${month}    12    December
    Log    ${month}
    [Return]    ${month}

Delete_Tag_From_Transaction
    Sleep    2S
    AppiumLibrary.Click Element    xpath=.//*[@id='wrapper']//div[@class='title' and contains(.,'NewTag')]
    ${Elements}=    AppiumLibrary.Get Elements    xpath =.//*[@id='wrapper']//div[@class='category list-item-expanded list-item']//div[contains(.,'NewTag')]//..//div[@class='subcategory list-item-collapsed list-item']
    ${SubCat}=    Get Length    ${Elements}
    : FOR    ${i}    IN RANGE    1    ${SubCat}+1
    \    AppiumLibrary.Click Element    ${objTagsSubCategaoriesNewTag}[${i}]
    AppiumLibrary.Capture Page Screenshot
    Run Keyword If    ${SubCat}==1    Run Keyword    Check_Transaction_Count
    ...    ELSE    Run Keyword    Transaction_Delete

Check_Transaction_Count
    ${Elements}=    AppiumLibrary.Get Elements    xpath = .//*[@id='wrapper']//div[@class='transactions list-view']//a
    ${Transaction}=    Get Length    ${Elements}
    Run Keyword If    ${Transaction}==1    Run Keyword    Tag_Delete
    ...    ELSE    Run Keyword    Transaction_Delete

Tag_Delete
    AppiumLibrary.Click Element    ${objTagFirstTransaction}
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Click Element    xpath=.//*[@id='wrapper']//div/a[@class='tag removable' and contains(.,'NewTag')]
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Click Element    ${objTransactionWindowDeleteButton}
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Page Should not contain element    xpath=.//*[@id='wrapper']//div/a[@class='tag removable' and contains(.,'NewTag')]
    AppiumLibrary.Click Element    ${objTransactionWindowCloseButton}
    Sleep    2S

Transaction_Delete
    AppiumLibrary.Click Element    ${objTagFirstTransaction}
    AppiumLibrary.Capture Page Screenshot
    ${ToName}=    AppiumLibrary.get element attribute    xpath=.//*[@id='wrapper']//div[@class='content']//dd/p[@class='to']    textContent
    AppiumLibrary.Click Element    xpath=.//*[@id='wrapper']//div/a[@class='tag removable' and contains(.,'NewTag')]
    AppiumLibrary.Capture Page Screenshot
    AppiumLibrary.Click Element    ${objTransactionWindowDeleteButton}
    AppiumLibrary.Capture Page Screenshot
    ${Elements}=    AppiumLibrary.Get Elements    xpath= .//*[@id='wrapper']//div/a[@class='tag removable' and contains(.,'NewTag')]
    ${var}=    Get Length    ${Elements}
    Check_TagValue    ${var}
    AppiumLibrary.Click Element    ${objTransactionWindowCloseButton}
    AppiumLibrary.Page Should Not Contain    xpath=.//*[@id='wrapper']//a//div[@class='beneficiary' and contains(.,'${ToName}')]/div[@class='tag' and contains(.,'NewTag')]

Verify_Tag_Module_Overall
    Comment    AppiumLibrary.Click Element    ${objTagsHeaderInactive}
    AppiumLibrary.Wait Until Page Contains Element    ${objTagsHeaderActive}    5S
    Sleep    2S
    ${Amount}=    AppiumLibrary.get element attribute    xpath=.//*[@id='wrapper']//div[@class='col col-1 list-view']/span/div[1]/div//div[@class='amount']    textContent
    @{TotalAmount}=    Split String    ${Amount}    €
    ${TAmount}=    Remove String    ${TotalAmount[1]}    ,
    ${TagAmt}=    Convert to Number    ${TAmount}
    AppiumLibrary.Click Element    xpath = .//*[@id='wrapper']//div[@class='col col-1 list-view']/span/div[1]/div//div[@class='amount']
    Sleep    2S
    ${Elements}=    AppiumLibrary.Get Elements    xpath = .//*[@id='wrapper']//div[@class='category list-item-expanded list-item']//div[1]//..//div[@class='subcategory list-item-collapsed list-item']
    ${SubCat}=    Get Length    ${Elements}
    : FOR    ${i}    IN RANGE    1    ${SubCat}+1
    \    AppiumLibrary.Click Element    ${objTagsSubCategaoriesNewTag}[${i}]
    AppiumLibrary.Capture Page Screenshot
    ${Total}=    Evaluate    0
    ${Elements}=    AppiumLibrary.Get Elements    xpath = .//*[@id='wrapper']//div[@class='transactions list-view']//a
    ${Transaction}=    Get Length    ${Elements}
    : FOR    ${j}    IN RANGE    1    ${Transaction}+1
    \    ${TranAmount}=    AppiumLibrary.get element attribute    xpath=.//*[@id='wrapper']//div[@class='transactions list-view']/div[${j}]/a//div[@class='amount']    textContent
    \    @{finalAmount}    Split String    ${TranAmount}    €
    \    ${var}=    Remove String    ${finalAmount[1]}    ,
    \    ${amt}=    Set Variable    ${var}
    \    ${tamt}=    Convert To String    ${amt}
    \    ${Total}=    Evaluate    ${Total}+${tamt}
    Log    ${Total}
    Should Be Equal    ${TagAmt}    ${Total}
    AppiumLibrary.Click Element    xpath=.//*[@id='wrapper']//div[@class='title' and contains(.,'NewTag')]
